!function(a,b,c){var d=a.OFFSET||{},e=b(a.document),f=b.cookie("valid_user"),g=b.cookie("logged_in"),h=b("#sec_token").text(),i={fetch:function(){return b.ajax({url:"/mysets"})}},j={create:function(a){return b.ajax({url:"/mysets",type:"POST",data:{name:a,_csrf:h}})},fetch:function(a){return b.ajax({url:"/mysets/"+a})},save:function(a,c){return b.ajax({url:"/mysets/"+a,type:"POST",data:{items:c}})}},k={create:function(a){return{item_type:"image",item_id:a}},saveToSet:function(a,b){return j.fetch(a).then(function(c){var d=c.items||[];return d.push(b),j.save(a,d)})}},l=function(a){return this.init(a),this};l.prototype={refreshSets:function(){this.sets=i.fetch()},init:function(e){var f=this;this.opts=b.extend(!0,{popoverConfig:{html:!0,placement:"bottom",container:"body",content:function(){var a=f.$target.data("tmpl-data");if(d.data&&d.data.setId&&d.data.setItems){var b=f.getMedia(),e=-1!==d.data.setItems.indexOf(b&&""+b.friendly_id);e&&(a.sets=c.filter(a.sets,function(a){return a.id!=d.data.setId})),a.sets.length||(a.sets=!1)}return a.i18n={language:d.user.locale.current||"en"},d.tmpl.render("partials/v2/add-to-set.html",a,[function(a){d.tmpl.i18n(a).init(d.i18n||{})}])}},selectors:{trigger:".js_add-to-set",cancel:".js_sets-manage-cancel",add:".js_sets-manage-add",create:".js_sets-manage-create",toggleMode:".js_sets-manage-toggle-view",auth:".js_auth-trigger",setId:'[name="set"]',setName:'[name="name"]'}},e),this.$$=this.opts.selectors,this.$target=b(),this.$delegate=this.opts.$delegate||b(a.document),this.sets=i.fetch(),this.setView(),this.refreshSets(),this.bindTrigger()},setView:function(a){this.$view=a&&a.length?a:b()},getMedia:function(){var a=this.$target.data("media-id")||this.$target.closest("[data-media-id]").data("media-id"),b=d.data.media[a];return this.$target.data("media",b),b},checkAuth:function(){return b.cookie("logged_in")},bindTrigger:function(){var a=this;b("body").on("click",function(c){var d,e,f=!!a.$view.length;f&&(d=b(c.target).is(a.$$.trigger)||b(c.target).closest(a.$$.trigger)[0],d||(e=b.contains(a.$view[0],c.target),e||a.hide()))}).on("click",this.$$.trigger,function(c){var e=b(c.target).is(a.$$.trigger)?b(c.target):b(c.target).closest(a.$$.trigger);c.preventDefault(),g?a.update(e):f?d.Components.LoginRegisterWidget.show({mode:"login"}):d.Components.LoginRegisterWidget.show({mode:"register"})})},bindHandlers:function(){var a=this;this.$view.on("click",this.$$.auth,function(c){c.preventDefault();var d=b(c.target).attr("href"),e=d&&d.indexOf("sign-in")>-1&&"login"||"register";a.hide(),a.$delegate.triggerHandler("loginregister.show",[{mode:e}])}).on("click",this.$$.cancel,function(b){b.preventDefault(),a.hide()}).on("submit",this.$$.add+" form",function(f){f.preventDefault();var g=a.getMedia(),h=k.create(g.friendly_id||g.id),i=b(f.target).find(a.$$.setId).val();k.saveToSet(i,h).then(function(f){var g=b.Deferred();a.sets.then(function(a){var b=c.filter(a,function(a){return a.id!=f.id});b.unshift(f),g.resolve(b),d.data&&d.data.setItems&&d.data.setId&&i==d.data.setId&&(d.data.setItems=c.pluck(f.items,"item_id"),e.triggerHandler("set.add",h.item_id))}),a.hide(),a.sets=g.promise()})}).on("submit",this.$$.create+" form",function(c){c.preventDefault();var d=b(c.target),e=a.getMedia(),f=k.create(e.friendly_id||e.id),g=d.find(a.$$.setName).val(),h=d.find("button");h.attr("disabled","disabled"),j.create(g).then(function(a){return k.saveToSet(a.id,f)}).then(function(){a.sets=i.fetch(),a.hide(),h.removeAttr("disabled")})}).on("click",this.$$.toggleMode,function(b){b.preventDefault(),a.toggleMode()})},render:function(a){var b=!this.$target.data("bs.popover");a&&this.$target.data("tmpl-data",a),this.$target.data("media")||this.getMedia(),this.$target.popover(this.opts.popoverConfig),this.setView(this.$target.data("bs.popover").tip()),this.$view.addClass("popover-offset"),b&&this.bindHandlers(),this.show()},update:function(a){var b=this.checkAuth();this.hide(),this.$target=a,this.render({authenticated:b,sets:[{name:"loading..."}],loading:!0}),b&&this.sets.then(c.bind(function(a){this.render({authenticated:!0,sets:a&&a.length?a:!1})},this))},show:function(){this.$target.popover("show"),this.$delegate.triggerHandler("addtoset.show",[this.$target])},hide:function(){this.$target.popover("destroy"),this.setView(!1),this.$delegate.trigger("addtoset.hide",[this.$target])},toggleMode:function(){var a=[this.$$.add,this.$$.create].join(",");this.$view.find(a).toggleClass("hide")}},d.Components=d.Components||{},d.Components.AddToSet=l,a.OFFSET=d}(this,jQuery,_);